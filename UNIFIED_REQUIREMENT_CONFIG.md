# ğŸ¯ Cáº¥u HÃ¬nh YÃªu Cáº§u Ná»™p Há»“ SÆ¡ - Há»‡ Thá»‘ng Thá»‘ng Nháº¥t

## ğŸ“‹ Tá»•ng Quan

**Cáº¥u HÃ¬nh YÃªu Cáº§u Ná»™p Há»“ SÆ¡** lÃ  má»™t tab má»›i thá»‘ng nháº¥t 3 chá»©c nÄƒng cÅ© thÃ nh **1 giao diá»‡n duy nháº¥t**:

| TÃ­nh NÄƒng | TrÆ°á»›c (3 Tab) | Hiá»‡n Táº¡i (1 Tab) |
|-----------|--------------|-----------------|
| **Quáº£n lÃ½ loáº¡i tÃ i liá»‡u** | Tab 1 (Loáº¡i tÃ i liá»‡u) | âœ… Gá»™p vÃ o |
| **Setup checklist items** | Tab 3 (YÃªu cáº§u Checklist) | âœ… Gá»™p vÃ o |
| **YÃªu cáº§u tá»«ng nhÃ  tháº§u** | Tab 2 (YÃªu cáº§u theo NCC) | âœ… Gá»™p vÃ o |

---

## ğŸ¨ Giao Diá»‡n Má»›i

### Layout Hierarchical

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cáº¥u HÃ¬nh YÃªu Cáº§u Ná»™p Há»“ SÆ¡ (NEW)          â”‚
â”‚  Táº¥t cáº£ trong 1 chá»— ğŸš€                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ HÆ°á»›ng Dáº«n Sá»­ Dá»¥ng â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ BÆ°á»›c 1: Má»Ÿ rá»™ng loáº¡i tÃ i liá»‡u             â”‚
â”‚ ğŸ“‹ BÆ°á»›c 2: Khá»Ÿi táº¡o Checklist (náº¿u chÆ°a)    â”‚
â”‚ ğŸ“‹ BÆ°á»›c 3: Toggle item báº¯t buá»™c             â”‚
â”‚ ğŸ“‹ BÆ°á»›c 4: Set yÃªu cáº§u tá»«ng nhÃ  tháº§u        â”‚
â”‚ âœ… Xong! NhÃ  tháº§u sáº½ tháº¥y ngay               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ Danh SÃ¡ch Loáº¡i TÃ i Liá»‡u (Expandable) â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚ â–¼ 1.1.1.1 Construction Manager             â”‚
â”‚   â”œâ”€ âœ… Checklist Items              2/9   â”‚
â”‚   â”‚  â”œâ”€ [o] ID Card                 [Báº¯t buá»™c]
â”‚   â”‚  â”œâ”€ [o] CV                      [Báº¯t buá»™c]
â”‚   â”‚  â””â”€ [o] Certificate              [TÃ¹y chá»n]
â”‚   â”‚                                          â”‚
â”‚   â””â”€ ğŸ‘¥ YÃªu Cáº§u Tá»«ng NhÃ  Tháº§u              â”‚
â”‚      â”œâ”€ NhÃ  Tháº§u A: 5 (Háº¡n: 2025-12-31)   â”‚
â”‚      â””â”€ NhÃ  Tháº§u B: 3 (Háº¡n: 2026-01-15)   â”‚
â”‚                                              â”‚
â”‚ â–¶ 1.1.1.2 HSE Manager                      â”‚
â”‚ â–¶ 1.1.2 Management Plan                    â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ThÃªm Loáº¡i TÃ i Liá»‡u Má»›i â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TÃªn*: [_____________] NhÃ³m*: [_____________] â”‚
â”‚ TÃªn TL: [_____________] Critical: [toggle] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ CÃ¡ch Sá»­ Dá»¥ng (Step-by-Step)

### **BÆ°á»›c 1: Truy cáº­p Admin Settings**
```
Dashboard â†’ Admin (ğŸ‘¤) â†’ Settings â†’ "Cáº¥u HÃ¬nh YÃªu Cáº§u (Má»›i)" Tab
```

### **BÆ°á»›c 2: Má»Ÿ Rá»™ng Loáº¡i TÃ i Liá»‡u**
```
Click vÃ o báº¥t ká»³ loáº¡i tÃ i liá»‡u nÃ o (VD: "1.1.1.1 Construction Manager")
â†’ Sáº½ hiá»‡n 2 section:
   - âœ… Checklist Items
   - ğŸ‘¥ YÃªu Cáº§u Tá»«ng NhÃ  Tháº§u
```

### **BÆ°á»›c 3: Khá»Ÿi Táº¡o Checklist (láº§n Ä‘áº§u)**
```
Náº¿u chÆ°a setup:
   Click nÃºt "Khá»Ÿi Táº¡o Checklist"
   â†’ Há»‡ thá»‘ng sáº½ load danh sÃ¡ch item tá»« HSE_CHECKLISTS
   â†’ Insert vÃ o database tá»± Ä‘á»™ng
   â†’ Show "ÄÃ£ thÃªm X má»¥c checklist"

Náº¿u Ä‘Ã£ setup:
   Checklist items sáº½ hiá»ƒn thá»‹ ngay vá»›i toggle
```

### **BÆ°á»›c 4: ÄÃ¡nh Dáº¥u Item Báº¯t Buá»™c**
```
Cho má»—i item trong Checklist Items:
   [o] = Toggle switch (má»Ÿ/táº¯t)
   
   Báº­t (on)  = "Báº¯t buá»™c"  (Badge xanh)
                â†’ NhÃ  tháº§u pháº£i ná»™p item nÃ y
   
   Táº¯t (off) = "TÃ¹y chá»n"  (Badge xÃ¡m)
                â†’ NhÃ  tháº§u cÃ³ thá»ƒ bá» qua

   Toggle 1 láº§n = Auto save (khÃ´ng cáº§n nÃºt LÆ°u)
```

### **BÆ°á»›c 5: Set YÃªu Cáº§u Tá»«ng NhÃ  Tháº§u**
```
Section "ğŸ‘¥ YÃªu Cáº§u Tá»«ng NhÃ  Tháº§u":

Cho má»—i nhÃ  tháº§u:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ NhÃ  Tháº§u A                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Sá»‘ lÆ°á»£ng yÃªu cáº§u:  [5 _ ]   â”‚
   â”‚ Háº¡n hoÃ n thÃ nh:    [2025-12-31] â”‚
   â”‚ [LÆ°u]                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Nháº­p:
   - Sá»‘ lÆ°á»£ng: Bao nhiÃªu document cáº§n ná»™p
   - Háº¡n: NgÃ y deadline cuá»‘i cÃ¹ng
   - Click "LÆ°u" â†’ Auto update DB
```

### **BÆ°á»›c 6: HoÃ n ThÃ nh**
```
âœ… Setup xong!

Hiá»‡u quáº£:
   â†’ NhÃ  tháº§u sáº½ tháº¥y:
     - ÄÃºng items báº¯t buá»™c trong checklist
     - ÄÃºng sá»‘ lÆ°á»£ng cáº§n ná»™p
     - ÄÃºng háº¡n deadline
   
   â†’ Khi ná»™p há»“ sÆ¡:
     - System auto validate checklist
     - Cháº·n ná»™p náº¿u thiáº¿u item báº¯t buá»™c
```

---

## ğŸ’¾ Dá»¯ Liá»‡u ÄÆ°á»£c LÆ°u

### **Báº£ng document_types**
```sql
{
  id: UUID,
  name: "1.1.1.1 Construction Manager",
  document_name: "MT_CM",
  category: "Management Teams",
  is_critical: false
}
```

### **Báº£ng checklist_requirements**
```sql
{
  id: UUID,
  doc_type_id: UUID,           -- Ref document_types
  checklist_item_id: "1.1.1.1",
  checklist_label: "ID Card",
  is_required: true,           -- Toggle nÃ y
  position: 0
}
```

### **Báº£ng contractor_requirements**
```sql
{
  id: UUID,
  doc_type_id: UUID,           -- Ref document_types
  contractor_id: UUID,         -- Ref contractors
  required_count: 5,           -- Nháº­p nÃ y
  planned_due_date: "2025-12-31" -- Nháº­p nÃ y
}
```

---

## ğŸ”— Káº¿t Ná»‘i Vá»›i NhÃ  Tháº§u (Frontend)

### **Khi nhÃ  tháº§u ná»™p há»“ sÆ¡:**

```typescript
// 1. Láº¥y yÃªu cáº§u cho doc_type
const docTypeId = selectedCategory.docTypeId;

// 2. Fetch checklist requirements tá»« DB
const { data: checklistItems } = supabase
  .from('checklist_requirements')
  .select('*')
  .eq('doc_type_id', docTypeId)
  .eq('is_required', true);  // â† Chá»‰ láº¥y báº¯t buá»™c

// 3. Fetch contractor requirements
const { data: contractorReq } = supabase
  .from('contractor_requirements')
  .select('required_count')
  .eq('doc_type_id', docTypeId)
  .eq('contractor_id', currentContractorId);

// 4. Validate submission
if (checkedItems.length < checklistItems.length) {
  showError("Thiáº¿u tÃ i liá»‡u báº¯t buá»™c");
  return;
}

if (checkedItems.length < contractorReq.required_count) {
  showError(`Cáº§n Ã­t nháº¥t ${contractorReq.required_count} tÃ i liá»‡u`);
  return;
}
```

---

## ğŸ“Š Æ¯u Äiá»ƒm So Vá»›i CÃ¡ch CÅ©

| TiÃªu ChÃ­ | CÃ¡ch CÅ© (3 Tab) | CÃ¡ch Má»›i (1 Tab) |
|---------|----------------|-----------------|
| **Sá»‘ tab** | 3 (rÆ°á»m rÃ ) | 1 (gá»n gÃ ng) |
| **Sá»‘ bÆ°á»›c setup** | 3 (Tab 1 â†’ Tab 3 â†’ Tab 2) | 1 (Má»Ÿ â†’ Setup xong) |
| **KhÃ³ hiá»ƒu** | âŒ Admin bá»‘i rá»‘i flow | âœ… Flow rÃµ rÃ ng |
| **Äá»“ng bá»™ dá»¯ liá»‡u** | âŒ Dá»… miss | âœ… Tá»± Ä‘á»™ng |
| **TÃ¬m hiá»ƒu** | âŒ 3 chá»— khÃ¡c nhau | âœ… 1 chá»— duy nháº¥t |
| **Hiá»‡u suáº¥t** | âŒ Load 3 tab | âœ… Load 1 tab |

---

## ğŸ› ï¸ Triá»ƒn Khai

### **BÆ°á»›c 1: Deploy Code**
```bash
git add src/components/admin/UnifiedRequirementConfig.tsx
git add src/pages/admin/settings.tsx
git commit -m "feat: unified requirement configuration UI"
git push
```

### **BÆ°á»›c 2: Admin Setup**
1. Login as admin
2. VÃ o Settings â†’ "Cáº¥u HÃ¬nh YÃªu Cáº§u (Má»›i)"
3. Setup láº§n lÆ°á»£t tá»«ng doc_type

### **BÆ°á»›c 3: Verify**
1. Logout + login as contractor
2. VÃ o "Ná»™p há»“ sÆ¡ má»›i"
3. Check xem checklist cÃ³ Ä‘Ãºng yÃªu cáº§u khÃ´ng

---

## ğŸ”„ Migration Tá»« CÃ¡ch CÅ© (Náº¿u CÃ³ Data)

Náº¿u báº¡n Ä‘Ã£ setup báº±ng 3 tab cÅ©:

```sql
-- Dá»¯ liá»‡u sáº½ váº«n cÃ²n, khÃ´ng máº¥t
-- Tab má»›i sáº½ read cÃ¹ng data tá»« 3 báº£ng:
-- - document_types
-- - checklist_requirements  
-- - contractor_requirements

-- KhÃ´ng cáº§n migration, chá»‰ cáº§n refresh browser
```

---

## âš™ï¸ TÃ¹y Chá»‰nh

### **Muá»‘n thÃªm item má»›i vÃ o checklist?**
```
1. Update HSE_CHECKLISTS trong checklistData.ts
2. Click "Khá»Ÿi táº¡o Checklist" láº¡i
3. Há»‡ thá»‘ng sáº½ thÃªm items má»›i
```

### **Muá»‘n xÃ³a má»™t item?**
```
Hiá»‡n táº¡i khÃ´ng cÃ³ UI delete (tÃ­nh nÄƒng sau)
CÃ¡ch táº¡m thá»i:
  1. Update DB trá»±c tiáº¿p (xÃ³a row)
  2. Refresh browser
```

### **Muá»‘n copy setup tá»« doc_type nÃ y sang khÃ¡c?**
```
Hiá»‡n táº¡i khÃ´ng cÃ³ feature copy (tÃ­nh nÄƒng sau)
CÃ¡ch táº¡m thá»i:
  1. Manual setup tá»«ng doc_type
  2. Hoáº·c update SQL trá»±c tiáº¿p
```

---

## ğŸ› Troubleshooting

### **Váº¥n Ä‘á»: Khá»Ÿi táº¡o Checklist khÃ´ng hiá»ƒn thá»‹ items**
```
NguyÃªn nhÃ¢n: HSE_CHECKLISTS khÃ´ng cÃ³ entry cho doc_type.name
Giáº£i phÃ¡p:
  1. Check tÃªn doc_type pháº£i match vá»›i key trong HSE_CHECKLISTS
  2. VD: doc_type.name = "1.1.1" 
       â†’ Check HSE_CHECKLISTS["1.1.1"] cÃ³ tá»“n táº¡i khÃ´ng
```

### **Váº¥n Ä‘á»: NhÃ  tháº§u khÃ´ng tháº¥y yÃªu cáº§u**
```
NguyÃªn nhÃ¢n: 
  1. Checklist chÆ°a khá»Ÿi táº¡o
  2. Contractor requirement chÆ°a set
  
Giáº£i phÃ¡p:
  1. Verify checklist_requirements cÃ³ data
  2. Verify contractor_requirements cÃ³ data cho contractor Ä‘Ã³
  3. Check RLS policies allow select
```

### **Váº¥n Ä‘á»: KhÃ´ng save Ä‘Æ°á»£c yÃªu cáº§u nhÃ  tháº§u**
```
NguyÃªn nhÃ¢n: Validation error hoáº·c DB constraint violation

Giáº£i phÃ¡p:
  1. Má»Ÿ browser console (F12)
  2. Check error message
  3. Verify required_count > 0
  4. Verify contractor tá»“n táº¡i
```

---

## ğŸ“š File LiÃªn Quan

```
src/components/admin/
  â”œâ”€ UnifiedRequirementConfig.tsx (NEW) â† Component chÃ­nh
  â”œâ”€ ChecklistRequirementsManager.tsx   (Legacy, optional delete)
  â””â”€ ...

src/pages/admin/
  â””â”€ settings.tsx (Updated)

src/lib/
  â””â”€ checklistData.ts (HSE_CHECKLISTS)

supabase/migrations/
  â””â”€ 20251028120000_checklist_requirements.sql
```

---

## ğŸ‰ TÃ³m Táº¯t

**TrÆ°á»›c (CÅ©):** 3 tab riÃªng láº» â†’ KhÃ³ setup â†’ Dá»… sai â†’ KhÃ´ng Ä‘á»“ng bá»™

**Sau (Má»›i):** 1 tab thá»‘ng nháº¥t â†’ Dá»… setup â†’ Tá»± Ä‘á»™ng validate â†’ Äá»“ng bá»™

**Káº¿t quáº£:** âš¡ **Setup nhanh gáº¥p 3 láº§n** âš¡
